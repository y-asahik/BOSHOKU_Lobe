# BOSHOKU Lobe 画像判定システム

Raspberry Pi + カメラを使用した高速画像判定システムです。Lobeで訓練されたモデルを使用して、リアルタイムで画像を分析し、GPIO出力で結果を通知します。

## 機能

- **高速判定**: 1.5秒間隔で安定した連続撮影・判定（非同期処理による遅延解消）
- **GPIO出力**: 判定結果に応じてDO1ピンを制御
- **ライブビュー**: リアルタイムでの判定結果表示（日時情報付き）
- **複数終了方法**: Enterキー、qキー、ウィンドウ×ボタンでの確実終了
- **自動フォーカス制御**: 初回起動時の自動フォーカス調整

## 判定クラス

システムは以下の2つのクラスを判定します：
- **OK**: 正常な状態
- **NG**: 不良状態（OK以外のすべて）

## ハードウェア要件

- Raspberry Pi (GPIO対応)
- USBカメラ (V4L2対応推奨)
- GPIO接続先デバイス

## GPIO設定

- **DO1_PIN**: 23番ピン (判定OK時にHIGH、NG時LOW)

## インストール

1. 必要なライブラリをインストール:
```bash
pip install opencv-python pillow numpy RPi.GPIO
```

2. Lobeライブラリをインストール:
```bash
cd lobe-python
pip install .
```

3. モデルファイルを配置:
```
path/to/exported/model/BOSHOKU TFLite/
├── saved_model.tflite
├── signature.json
└── labels.txt
```

## 設定

`app.py`の上部で以下の設定を変更できます:

```python
# 判定間隔設定
judgment_interval = 1.5   # 判定間隔（秒）

# トリミング領域 (左上x, 左上y, 幅, 高さ)
x, y, w, h = 195, 140, 200, 200

# フォーカス値（オートフォーカス制御用）
focus_value = 255
```

## 使用方法

1. システムを起動:
```bash
python app.py
```

2. プログラム終了（3つの方法）:
```
方法1: コンソールでEnterキーを押す
方法2: ライブビューウィンドウで'q'キーを押す  
方法3: ライブビューウィンドウの×ボタンをクリック
```

## 判定結果とGPIO出力

| 判定結果 | DO1_PIN | 説明 |
|---------|---------|------|
| OK      | HIGH    | 正常 |
| NG      | LOW     | 不良 |

## システム改善点（v2.0）

### パフォーマンス最適化
- **非同期処理**: AI推論を専用スレッドに分離、フレーム取得の継続実行
- **軽量化**: ファイル保存・CSV出力機能を削除、判定処理に集中
- **安定性向上**: 毎秒判定の確実な実行

### 操作性改善  
- **複数終了方法**: 3つの終了方法で確実なアプリケーション終了
- **ライブビュー**: リアルタイムでの判定結果とタイムスタンプ表示

## トラブルシューティング

### カメラが認識されない
```bash
# カメラデバイスの確認
ls /dev/video*

# v4l2-ctlでカメラ設定確認
v4l2-ctl -d /dev/video0 --list-formats-ext
```

### GPIO権限エラー
```bash
# 実行権限でスクリプトを起動
sudo python app.py
```

### フォーカスが合わない
`focus_value`の値を調整してください（通常200-300の範囲）。初回起動時に自動フォーカス調整が実行されます。

### 判定が遅い場合
v2.0で非同期処理により大幅に改善されています。それでも遅い場合は：
- `judgment_interval`を調整（例：1.5秒）
- RaspberryPiのCPU使用率を確認

## 技術仕様

### アーキテクチャ
- **メインスレッド**: ライブビュー表示とユーザー入力処理
- **判定スレッド**: AI推論の非同期実行
- **フレームキュー**: スレッド間のデータ受け渡し（最大2フレーム）

### 判定間隔の変更
```python
judgment_interval = 0.5  # 0.5秒間隔で高速判定
judgment_interval = 2.0  # 2秒間隔で低負荷運用
```